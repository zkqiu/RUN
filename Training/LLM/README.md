# SFT LLM è®­ç»ƒä»£ç 

è¿™æ˜¯ä¸€ä¸ªç”¨äºå¤§è¯­è¨€æ¨¡å‹ç›‘ç£å¾®è°ƒï¼ˆSupervised Fine-Tuning, SFTï¼‰çš„å®Œæ•´è®­ç»ƒæ¡†æ¶ï¼Œæ”¯æŒChatMLæ ¼å¼æ•°æ®ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸš€ æ”¯æŒå¤šç§é¢„è®­ç»ƒæ¨¡å‹ï¼ˆQwen2.5ã€Llama3ç­‰ï¼‰
- ğŸ“ å®Œæ•´çš„ChatMLæ ¼å¼æ•°æ®å¤„ç†
- âš™ï¸ çµæ´»çš„é…ç½®ç³»ç»Ÿ
- ğŸ”§ æ”¯æŒå¤šç§è®­ç»ƒä¼˜åŒ–æŠ€æœ¯
- ğŸ’¬ äº¤äº’å¼æ¨ç†å’Œæ‰¹é‡æ¨ç†
- ğŸ“Š å®Œæ•´çš„è®­ç»ƒç›‘æ§å’Œæ—¥å¿—

## æ–‡ä»¶ç»“æ„

```text
Training/LLM/
â”œâ”€â”€ sft_train.py          # ä¸»è®­ç»ƒè„šæœ¬
â”œâ”€â”€ data_utils.py         # æ•°æ®å¤„ç†å·¥å…·
â”œâ”€â”€ config.py             # é…ç½®æ–‡ä»¶
â”œâ”€â”€ inference.py          # æ¨ç†è„šæœ¬
â”œâ”€â”€ requirements.txt      # ä¾èµ–åŒ…
â”œâ”€â”€ README.md            # è¯´æ˜æ–‡æ¡£
â””â”€â”€ data/                # æ•°æ®ç›®å½•
    â””â”€â”€ chatml_data.json # ç¤ºä¾‹æ•°æ®
```

## å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### 2. å‡†å¤‡æ•°æ®

ä½¿ç”¨ChatMLæ ¼å¼å‡†å¤‡è®­ç»ƒæ•°æ®ï¼š

```python
from data_utils import ChatMLDataProcessor

processor = ChatMLDataProcessor()

# åˆ›å»ºç¤ºä¾‹æ•°æ®
sample_data = [
    processor.create_chatml_sample(
        system="ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ã€‚",
        user="ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ",
        assistant="æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªåˆ†æ”¯..."
    ),
    # æ›´å¤šæ•°æ®...
]

# ä¿å­˜æ•°æ®
processor.save_chatml_data(sample_data, "./data/chatml_data.json")
```

æˆ–è€…ç›´æ¥è¿è¡Œæ•°æ®ç”Ÿæˆè„šæœ¬ï¼š

```bash
python data_utils.py
```

### 3. å¼€å§‹è®­ç»ƒ

#### ä½¿ç”¨é»˜è®¤é…ç½®è®­ç»ƒ

```bash
python sft_train.py \
    --model_name "Qwen/Qwen2.5-0.5B" \
    --data_path "./data/chatml_data.json" \
    --output_dir "./outputs/sft_model" \
    --num_epochs 3 \
    --batch_size 4 \
    --learning_rate 5e-5
```

#### ä½¿ç”¨é¢„å®šä¹‰é…ç½®

```python
from config import get_config
from sft_train import SFTTrainer

# è·å–é¢„å®šä¹‰é…ç½®
config = get_config("qwen2.5-0.5b")

# åˆ›å»ºè®­ç»ƒå™¨
trainer = SFTTrainer(
    model_args=config["model"],
    data_args=config["data"], 
    training_args=config["training"]
)

# å¼€å§‹è®­ç»ƒ
trainer.train()
```

### 4. æ¨¡å‹æ¨ç†

#### äº¤äº’å¼èŠå¤©

```bash
python inference.py \
    --model_path "./outputs/sft_model" \
    --mode chat \
    --system_prompt "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ã€‚"
```

#### æ‰¹é‡æ¨ç†

```bash
python inference.py \
    --model_path "./outputs/sft_model" \
    --mode batch \
    --data_path "./data/test_data.json" \
    --output_path "./outputs/predictions.json"
```

## é…ç½®è¯´æ˜

### æ¨¡å‹é…ç½®

- `model_name`: é¢„è®­ç»ƒæ¨¡å‹åç§°æˆ–è·¯å¾„
- `trust_remote_code`: æ˜¯å¦ä¿¡ä»»è¿œç¨‹ä»£ç 
- `torch_dtype`: æ•°æ®ç±»å‹ï¼ˆfloat16/float32/bfloat16ï¼‰
- `device_map`: è®¾å¤‡æ˜ å°„ç­–ç•¥

### æ•°æ®é…ç½®

- `train_data_path`: è®­ç»ƒæ•°æ®è·¯å¾„
- `max_length`: æœ€å¤§åºåˆ—é•¿åº¦
- `ignore_index`: å¿½ç•¥çš„æ ‡ç­¾ç´¢å¼•
- `data_loader_num_workers`: æ•°æ®åŠ è½½å™¨å·¥ä½œè¿›ç¨‹æ•°

### è®­ç»ƒé…ç½®

- `num_train_epochs`: è®­ç»ƒè½®æ•°
- `per_device_train_batch_size`: æ¯è®¾å¤‡æ‰¹æ¬¡å¤§å°
- `gradient_accumulation_steps`: æ¢¯åº¦ç´¯ç§¯æ­¥æ•°
- `learning_rate`: å­¦ä¹ ç‡
- `weight_decay`: æƒé‡è¡°å‡
- `warmup_ratio`: é¢„çƒ­æ¯”ä¾‹
- `fp16`: æ˜¯å¦ä½¿ç”¨åŠç²¾åº¦è®­ç»ƒ

## ChatMLæ•°æ®æ ¼å¼

è®­ç»ƒæ•°æ®åº”ä½¿ç”¨ChatMLæ ¼å¼ï¼Œç¤ºä¾‹ï¼š

```json
[
  {
    "messages": [
      {
        "role": "system",
        "content": "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ã€‚"
      },
      {
        "role": "user", 
        "content": "ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ"
      },
      {
        "role": "assistant",
        "content": "æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªåˆ†æ”¯..."
      }
    ]
  }
]
```

## æ”¯æŒçš„æ¨¡å‹

- Qwen2.5ç³»åˆ—ï¼ˆ0.5B, 1.5B, 7B, 14B, 32B, 72Bï¼‰
- Llama3ç³»åˆ—ï¼ˆ8B, 70Bï¼‰
- å…¶ä»–å…¼å®¹çš„Hugging Faceæ¨¡å‹

## è®­ç»ƒä¼˜åŒ–å»ºè®®

### å†…å­˜ä¼˜åŒ–

1. **ä½¿ç”¨æ¢¯åº¦æ£€æŸ¥ç‚¹**ï¼šå‡å°‘æ˜¾å­˜å ç”¨
2. **è°ƒæ•´æ‰¹æ¬¡å¤§å°**ï¼šæ ¹æ®GPUæ˜¾å­˜è°ƒæ•´
3. **ä½¿ç”¨DeepSpeed**ï¼šæ”¯æŒZeROä¼˜åŒ–
4. **é‡åŒ–è®­ç»ƒ**ï¼šä½¿ç”¨8bitæˆ–4bité‡åŒ–

### è®­ç»ƒç­–ç•¥

1. **å­¦ä¹ ç‡è°ƒåº¦**ï¼šä½¿ç”¨warmup + linear decay
2. **æ¢¯åº¦è£å‰ª**ï¼šé˜²æ­¢æ¢¯åº¦çˆ†ç‚¸
3. **æƒé‡è¡°å‡**ï¼šé˜²æ­¢è¿‡æ‹Ÿåˆ
4. **æ—©åœæœºåˆ¶**ï¼šé¿å…è¿‡è®­ç»ƒ

### æ•°æ®è´¨é‡

1. **æ•°æ®æ¸…æ´—**ï¼šç§»é™¤ä½è´¨é‡æ ·æœ¬
2. **æ•°æ®å¹³è¡¡**ï¼šç¡®ä¿ä»»åŠ¡ç±»å‹å¹³è¡¡
3. **æ•°æ®å¢å¼º**ï¼šå¢åŠ æ•°æ®å¤šæ ·æ€§
4. **æ ¼å¼ç»Ÿä¸€**ï¼šç¡®ä¿ChatMLæ ¼å¼æ­£ç¡®

## å¸¸è§é—®é¢˜

### Q: è®­ç»ƒæ—¶æ˜¾å­˜ä¸è¶³æ€ä¹ˆåŠï¼Ÿ

A: å¯ä»¥å°è¯•ä»¥ä¸‹æ–¹æ³•ï¼š

- å‡å°æ‰¹æ¬¡å¤§å°
- å¢åŠ æ¢¯åº¦ç´¯ç§¯æ­¥æ•°
- ä½¿ç”¨DeepSpeed ZeRO
- å¯ç”¨æ¢¯åº¦æ£€æŸ¥ç‚¹
- ä½¿ç”¨é‡åŒ–è®­ç»ƒ

### Q: å¦‚ä½•è¯„ä¼°æ¨¡å‹æ•ˆæœï¼Ÿ

A: å¯ä»¥ï¼š

- ä½¿ç”¨éªŒè¯é›†è®¡ç®—å›°æƒ‘åº¦
- è¿›è¡Œäººå·¥è¯„ä¼°
- ä½¿ç”¨è‡ªåŠ¨è¯„ä¼°æŒ‡æ ‡ï¼ˆBLEUã€ROUGEç­‰ï¼‰
- è¿›è¡ŒA/Bæµ‹è¯•

### Q: è®­ç»ƒé€Ÿåº¦å¤ªæ…¢æ€ä¹ˆåŠï¼Ÿ

A: å¯ä»¥ï¼š

- ä½¿ç”¨æ›´å¤§çš„æ‰¹æ¬¡å¤§å°
- å¯ç”¨æ··åˆç²¾åº¦è®­ç»ƒï¼ˆfp16ï¼‰
- ä½¿ç”¨å¤šGPUè®­ç»ƒ
- ä¼˜åŒ–æ•°æ®åŠ è½½
- ä½¿ç”¨æ›´å¿«çš„å­˜å‚¨è®¾å¤‡

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ã€‚

## è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestï¼

## æ›´æ–°æ—¥å¿—

- v1.0.0: åˆå§‹ç‰ˆæœ¬ï¼Œæ”¯æŒåŸºæœ¬çš„SFTè®­ç»ƒ
- æ”¯æŒChatMLæ ¼å¼æ•°æ®å¤„ç†
- æ”¯æŒå¤šç§é¢„è®­ç»ƒæ¨¡å‹
- æä¾›å®Œæ•´çš„è®­ç»ƒå’Œæ¨ç†æµç¨‹
